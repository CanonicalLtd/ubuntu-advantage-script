#!/bin/bash -e
# shellcheck disable=SC2039,SC1090

SCRIPTNAME=$(basename "$0")

# Services managed by the script
SERVICES="esm fips livepatch"

# system details
SERIES=${SERIES:-$(lsb_release -cs)}
KERNEL_VERSION=${KERNEL_VERSION:-$(uname -r)}
ARCH=${ARCH:-$(uname -m)}
# system files
FSTAB=${FSTAB:-"/etc/fstab"}
CPUINFO=${CPUINFO:-"/proc/cpuinfo"}
KEYRINGS_DIR=${KEYRINGS_DIR:-"/usr/share/keyrings"}
APT_AUTH_FILE=${APT_AUTH_FILE:-"/etc/apt/auth.conf"}
APT_KEYS_DIR=${APT_KEYS_DIR:-"/etc/apt/trusted.gpg.d"}
APT_METHOD_HTTPS=${APT_METHOD_HTTPS:-"/usr/lib/apt/methods/https"}
CA_CERTIFICATES=${CA_CERTIFICATES:-"/usr/sbin/update-ca-certificates"}
# system binaries
SNAPD=${SNAPD:-"/usr/lib/snapd/snapd"}
APT_HELPER=${APT_HELPER:-"/usr/lib/apt/apt-helper"}

load_modules() {
    local script_dir modules_dir
    script_dir=$(dirname "$0")
    if [ "$script_dir" = "/usr/bin" ]; then
        modules_dir="/usr/share/ubuntu-advantage-tools/modules"
    else
        modules_dir="${script_dir}/modules"
    fi

    local module
    for module in "$modules_dir"/*.sh; do
        . "$module"
    done
}

print_status() {
    local esm_status
    if esm_is_enabled; then
        esm_status="enabled"
    else
        esm_status="disabled"
        is_supported_series "$ESM_SUPPORTED_SERIES" || esm_status="disabled (not available)"
    fi
    echo "esm: $esm_status"

    local livepatch_status livepatch_output
    if livepatch_is_enabled; then
        livepatch_status="enabled"
        livepatch_output=$(canonical-livepatch status)
    else
        livepatch_status="disabled"
        is_supported_series "$LIVEPATCH_SUPPORTED_SERIES" || livepatch_status="disabled (not available)"
    fi
    echo "livepatch: $livepatch_status"
    if [ "$livepatch_output" ]; then
        # shellcheck disable=SC2001
        echo "$livepatch_output" | sed 's/^/  /'  # indent output
    fi

    local fips_status
    if fips_is_enabled; then
        fips_status="enabled"
    else
        fips_status="disabled"
        is_supported_series "$FIPS_SUPPORTED_SERIES" || fips_status="disabled (not available)"
    fi
    echo "fips: $fips_status"
}

usage() {
    cat >&2 <<EOF
usage: ${SCRIPTNAME} <command> [parameters]

This is a tool that facilitates access to some of Canonical's
Ubuntu Advantage offerings.

Currently available are:
- Ubuntu Extended Security Maintenance archive (https://ubuntu.com/esm)
- Canonical Livepatch Service (https://www.ubuntu.com/server/livepatch)
- Canonical FIPS 140-2 Certified Modules

Commands:
 version                   show the tool version
 status                    show current status of Ubuntu Advantage offerings
 enable-esm <token>        enable the ESM repository
 disable-esm               disable the ESM repository
 enable-livepatch <token>  enable the Livepatch service
 disable-livepatch [-r]    disable the Livepatch service. With "-r", the
                           canonical-livepatch snap will also be removed
 enable-fips <token>       enable the FIPS PPA repository and install,
                           configure and enable FIPS certified modules
 disable-fips               currently not supported
 update-fips <token> [-y]  Install and enable updated non-certified FIPS
                           modules. With "-y" or "--yes" the user prompt
                           will be bypassed.
EOF
    exit 1
}

main() {
    local command="$1"

    local service
    service=$(service_from_command "$command")
    # if the command contains a service name, check that it's valid
    if [ "$service" ] && ! name_in_list "$service" "$SERVICES"; then
        error_msg "Invalid command: \"$command\""
        usage
    fi

    case "$command" in

        disable-livepatch)
            check_user
            service_check_support livepatch
            local remove_snap="no"
            if [ -n "$2" ]; then
                if [ "$2" = "-r" ]; then
                    remove_snap="yes"
                else
                    error_msg "Unknown option \"$2\""
                    usage
                fi
            fi
            livepatch_disable "$remove_snap"
            ;;

        disable-esm)
            check_user
            service_check_support esm
            esm_disable
            ;;

        disable-fips)
            if fips_is_enabled; then
                not_supported 'Disabling FIPS'
            else
                error_msg 'FIPS is not enabled.'
                exit 1
            fi
            ;;

        status)
            print_status
            ;;

        version)
            package_version ubuntu-advantage-tools
            ;;

        enable-*)
            local token="$2"
            service_enable "$service" "$token"
            ;;

        update-*)
            local token="$2"
            local bypass_prompt=0
            while true ; do
               case "$3" in
                  --yes | -y)
                     bypass_prompt=1
                     break;
                     ;;
                  *)
                     break;
                     ;;
               esac
            done;
            service_update "$service" "$token" "$bypass_prompt"
            ;;

        is-*-enabled)
            service_is_enabled "$service"
            ;;

        *)
            error_msg "Invalid command: \"$command\""
            usage
            ;;
    esac
}


load_modules
main "$@"
